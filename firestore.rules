rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - role-based access control
    match /users/{userId} {
      // CRITICAL: Users can ALWAYS read and write their own profile
      // This must be the FIRST rule and use NO helper functions to avoid circular dependency
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Admins can read all users in their organization
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      
      // Super admins can read all users
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
      
      // Admins can update users in their organization (except role changes)
      allow update: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId &&
        request.resource.data.role == resource.data.role;
      
      // Super admins can update any user including role changes
      allow update: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Interviews collection - admin-level access control
    match /interviews/{interviewId} {
      // Students can read and update their own interviews
      allow read, update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // Students can create interviews for themselves (no orgId required for regular users)
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // Admins can read all interviews in their organization
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      
      // Super admins can read all interviews
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
      
      // Admins can create, update, and delete interviews in their organization
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == request.resource.data.orgId;
      
      // Super admins have full access
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
      
      // Interview metrics sub-collection
      match /metrics/{metricId} {
        // Students can read and write their own interview metrics
        allow read, write: if request.auth != null && 
          get(/databases/$(database)/documents/interviews/$(interviewId)).data.userId == request.auth.uid;
        
        // Admins can read metrics for interviews in their organization
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == get(/databases/$(database)/documents/interviews/$(interviewId)).data.orgId;
        
        // Super admins can read all metrics
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
        
        // Admins can write metrics in their organization
        allow write: if request.auth != null && 
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == get(/databases/$(database)/documents/interviews/$(interviewId)).data.orgId;
        
        // Super admins have full access
        allow write: if request.auth != null && 
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
      }
    }
    
    // Organizations collection - admin access only
    match /organizations/{orgId} {
      // Admins can read their own organization
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == orgId;
      
      // Super admins can read all organizations
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
      
      // Admins can update their own organization (limited fields)
      allow update: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == orgId &&
        request.resource.data.keys().hasAll(['name', 'settings']) &&
        request.resource.data.quotaLimit == resource.data.quotaLimit &&
        request.resource.data.plan == resource.data.plan;
      
      // Super admins have full access
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // System settings - super admin only
    match /systemSettings/{settingId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // orgStudents collection - org members and admins
    match /orgStudents/{studentId} {
      // Org members can read students in their org
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      
      // Org admins can write students in their org
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == request.resource.data.orgId;
      
      // Super admins have full access
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Legacy collections for backward compatibility
    match /mockSessions/{sessionId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    match /userProgress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}