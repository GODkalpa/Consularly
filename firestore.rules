rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users collection - role-based access control
    match /users/{userId} {
      // CRITICAL: Users can ALWAYS read and write their own profile
      // This must be the FIRST rule and use NO helper functions to avoid circular dependency
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Admins can read all users
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Admins can update any user including role changes
      allow update: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Interviews collection - admin-level access control
    match /interviews/{interviewId} {
      // Students can read and update their own interviews
      allow read, update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // Students can create interviews for themselves (no orgId required for regular users)
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // Admins can read all interviews
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Admins have full write access to all interviews
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Interview metrics sub-collection
      match /metrics/{metricId} {
        // Students can read and write their own interview metrics
        allow read, write: if request.auth != null && 
          get(/databases/$(database)/documents/interviews/$(interviewId)).data.userId == request.auth.uid;
        
        // Admins can read all metrics
        allow read: if request.auth != null && 
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
        
        // Admins have full write access to all metrics
        allow write: if request.auth != null && 
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Interview responses sub-collection
      match /responses/{responseId} {
        // Students can read and write their own interview responses
        allow read, write: if request.auth != null &&
          get(/databases/$(database)/documents/interviews/$(interviewId)).data.userId == request.auth.uid;

        // Admins can read all responses
        allow read: if request.auth != null &&
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

        // Admins have full write access to all responses
        allow write: if request.auth != null &&
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
    }
    
    // Organizations collection - admin access only
    match /organizations/{orgId} {
      // Admins can read all organizations
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Admins have full write access to all organizations
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // System settings - admin only
    match /systemSettings/{settingId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // orgStudents collection - org members and admins
    match /orgStudents/{studentId} {
      // Org members can read students in their org
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId == resource.data.orgId;
      
      // Admins have full read/write access to all org students
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Accounting collections - admin-only access
    match /expenses/{expenseId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /incomes/{incomeId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /subscriptions/{subscriptionId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /invoices/{invoiceId} {
      allow read, write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /accounting_audit_log/{logId} {
      // Admins can read audit logs
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // No direct writes allowed - audit logs are created server-side only
      allow write: if false;
    }
    
    // Legacy collections for backward compatibility
    match /mockSessions/{sessionId} {
      allow read, write: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    match /userProgress/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}